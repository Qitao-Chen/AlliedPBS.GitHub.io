<!DOCTYPE html>
<html lang="en">

<head>
    <!-- <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"> -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="./index.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
</head>
<script src="https://kit.fontawesome.com/faca7d3472.js" crossorigin="anonymous"></script>

<!-- Start of Async Drift Code -->
<script>
    "use strict";

    ! function () {
        var t = window.driftt = window.drift = window.driftt || [];
        if (!t.init) {
            if (t.invoked) return void(window.console && console.error && console.error(
                "Drift snippet included twice."));
            t.invoked = !0, t.methods = ["identify", "config", "track", "reset", "debug", "show", "ping", "page",
                    "hide", "off", "on"
                ],
                t.factory = function (e) {
                    return function () {
                        var n = Array.prototype.slice.call(arguments);
                        return n.unshift(e), t.push(n), t;
                    };
                }, t.methods.forEach(function (e) {
                    t[e] = t.factory(e);
                }), t.load = function (t) {
                    var e = 3e5,
                        n = Math.ceil(new Date() / e) * e,
                        o = document.createElement("script");
                    o.type = "text/javascript", o.async = !0, o.crossorigin = "anonymous", o.src =
                        "https://js.driftt.com/include/" + n + "/" + t + ".js";
                    var i = document.getElementsByTagName("script")[0];
                    i.parentNode.insertBefore(o, i);
                };
        }
    }();
    drift.SNIPPET_VERSION = '0.3.1';
    drift.load('eshuravrkwt6');
</script>
<!-- End of Async Drift Code -->

<body>
    <div class="wrapper">
        <div class="header">
            <div class="logo">
                <img src="https://alliedgamingpc.com.au//wp-content/uploads/2019/11/allied-logo-inverse.png" alt="">
                <!-- <span>Allied Gaming</span> -->
            </div>
        </div>
        <div class="left-menu">
            <dl id="menu">
                <dt>Priority Build</dt>
                <dd class="active" data-id="student-list">Order List</dd>
                <dd data-id="add-student">Add Order</dd>
            </dl>
            <div class="statistic-area">
                <div class="waiting-order-num">
                    <h5>Waiting Orders</h5>
                    <span id="waiting-order-num-display">0</span>
                </div>
                <div class="completed-order-num">
                    <h5>Completed Orders</h5>
                    <span id="completed-order-num-display">0</span>
                </div>
            </div>
        </div>
        <div class="right-content">
            <!-- 学生列表 -->
            <div class="student-list content" id="student-list">
                <div class="search">
                    <label for="search-word">KeyWords Search:</label>
                    <input type="text" id="search-word">
                    <button id="search-submit">search</button>
                    <!-- 新增功能 -->
                    <input style="margin-left: 5px;" id="waiting-show" type="radio" name="sex" value="0">
                    <label for="waiting-show">Waiting</label>
                    <input style="margin-left: 5px;" id="completed-show" type="radio" name="sex" value="1">
                    <label for="completed-show">Completed</label>
                    <input style="margin-left: 5px;" type="checkbox" id="update-page" name="autoUpdate"
                        onclick="autoUpdateHandler()">
                    <label for="update-page">Auto Update</label>
                </div>
                <div class="table-area">
                    <!-- waiting-table -->
                    <div class="table-area-waiting">
                        <table border="0" class="table table-hover table-light table-waiting">
                            <!-- 表头区域 -->
                            <thead>
                                <tr>
                                    <th scope="col">List</th>
                                    <th scope="col">Name</th>
                                    <th scope="col">Notes</th>
                                    <th scope="col">Status</th>
                                    <!-- <th scope="col">Email</th>
                            <th scope="col">Year</th>
                            <th scope="col">N/A</th> -->
                                    <th scope="col">Operation</th>
                                </tr>
                            </thead>
                            <!-- 表格内容 -->
                            <tbody id="student-body-waiting">
                            </tbody>
                        </table>
                        <ul id="turn-page">
                        </ul>
                    </div>
                    <!-- completed table -->
                    <div class="table-area-completed">
                        <table border="0" class="table table-hover table-light table-completed">
                            <!-- 表头区域 -->
                            <thead>
                                <tr>
                                    <th scope="col">List</th>
                                    <th scope="col">Name</th>
                                    <th scope="col">Notes</th>
                                    <th scope="col">Status</th>
                                    <!-- <th scope="col">Email</th>
                            <th scope="col">Year</th>
                            <th scope="col">N/A</th> -->
                                    <th scope="col">Operation</th>
                                </tr>
                            </thead>
                            <!-- 表格内容 -->
                            <tbody id="student-body-completed">
                            </tbody>
                        </table>

                    </div>
                </div>

                <div class="modal" id="modal">
                    <div class="mask"></div>
                    <div class="modal-content">
                        <h2>Edit Order</h2>
                        <form action="#" id="edit-student-form" class="add-student-form">
                            <div class="row-mb-3">
                                <label for="name" class="col-sm-2 col-form-label col-form-label-sm">Name</label>
                                <div class="short-input col-md-8">
                                    <input type="text" name="name" autocomplete="off"
                                        class="form-control form-control-sm">
                                </div>
                            </div>
                            <div class="sex">
                                <label for="sex">Status</label>
                                <input type="radio" name="sex" checked value="0">
                                <span>waiting</span>
                                <input type="radio" name="sex" value="1"><span>completed</span>
                            </div>

                            <div class="row-mb-3">
                                <label for="sNo" class="col-sm-2 col-form-label">List</label>
                                <div class="short-input col-md-8">
                                    <input type="text" name="sNo" class="form-control">
                                </div>
                            </div>
                            <div class="row-mb-3">
                                <label for="email" class="col-sm-2 col-form-label">Email</label>
                                <div class="short-input col-md-8">
                                    <input type="text" name="email" class="form-control">
                                </div>
                            </div>
                            <div class="row-mb-3">
                                <label for="birth" class="col-sm-2 col-form-label">Year</label>
                                <div class="short-input col-md-8">
                                    <input type="text" name="birth" class="form-control" id="birthEdit">
                                </div>
                            </div>
                            <div class="row-mb-3">
                                <label for="phone" class="col-sm-2 col-form-label">N/A</label>
                                <div class="short-input col-md-8">
                                    <input type="text" name="phone" class="form-control" value="13000000000">
                                </div>
                            </div>
                            <div class="row-mb-3">
                                <label for="address" class="col-sm-2 col-form-label">Notes</label>
                                <div class="short-input col-md-8">
                                    <input type="text" name="address" class="form-control">
                                </div>
                            </div>
                            <div>
                                <label for=""></label>
                                <input type="submit" value="Submit" class="btn btn-primary" id="edit-submit">
                                <input type="reset" value="Reset" class="btn btn-danger">
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <!-- 新增学生表单 -->
            <div class="add-student content" id="add-student">
                <form action="#" id="add-student-form" class="add-student-form">
                    <div class="row-mb-3">
                        <label for="name" class="col-sm-2 col-form-label col-form-label-sm">Name</label>
                        <div class="short-input col-md-8">
                            <input type="text" name="name" autocomplete="off" class="form-control form-control-sm">
                        </div>
                    </div>
                    <div class="sex">
                        <label for="sex">Status</label>
                        <input type="radio" name="sex" checked value="0">
                        <span>waiting</span>
                        <input type="radio" name="sex" value="1"><span>completed</span>
                    </div>

                    <div class="row-mb-3">
                        <label for="sNo" class="col-sm-2 col-form-label">List</label>
                        <div class="short-input col-md-8">
                            <input type="text" name="sNo" class="form-control" id="add-sNo">
                        </div>
                    </div>
                    <div class="row-mb-3">
                        <label for="email" class="col-sm-2 col-form-label">Email</label>
                        <div class="short-input col-md-8">
                            <input type="text" name="email" class="form-control" id="add-email">
                        </div>
                    </div>
                    <div class="row-mb-3">
                        <label for="birth" class="col-sm-2 col-form-label">Year</label>
                        <div class="short-input col-md-8">
                            <input type="text" name="birth" class="form-control" id="birth">
                        </div>
                    </div>
                    <div class="row-mb-3">
                        <label for="phone" class="col-sm-2 col-form-label">N/A</label>
                        <div class="short-input col-md-8">
                            <input type="text" name="phone" class="form-control" value="13000000000">
                        </div>
                    </div>
                    <div class="row-mb-3">
                        <label for="address" class="col-sm-2 col-form-label">Notes</label>
                        <div class="short-input col-md-8">
                            <input type="text" name="address" class="form-control">
                        </div>
                    </div>
                    <div>
                        <label for=""></label>
                        <input type="submit" value="Submit" class="btn btn-primary" id="add-submit">
                        <input type="reset" value="Reset" class="btn btn-danger">
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.js"
        integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous">
    </script>
    <script>
        (function () {

            function TurnPage(options) {
                this.wrap = options.wrap;
                this.curPage = options.curPage || 1;
                this.allPage = options.allPage || 1;
                this.changePage = options.changePage || function () {};

                if (this.curPage > this.allPage) {
                    alert('请输入正确页码');
                    return false;
                }
                this.fillHTML();
                this.bindEvent();
            }
            TurnPage.prototype.fillHTML = function () {
                $(this.wrap).empty();
                // 添加上一页按钮
                if (this.curPage > 1) {
                    $(this.wrap).append($('<li class="prev-page">Previous</li>'));
                } else {
                    $(this.wrap).remove('.prev-page');
                }

                // 填充中间页 
                // 如果当前页不是第一页  并且当前页与第一页之间差2页以及两页以上  添加第一页
                if (this.curPage != 1 && this.curPage - 2 > 1) {
                    $(this.wrap).append($('<li class="tab-number">1</li>'));
                }

                // 如果当前页的前两页 大于第二页 则出现省略号
                if (this.curPage - 2 > 2) {
                    $(this.wrap).append($('<span>...</span>'));
                }

                // 渲染当前页数左右两页
                for (var i = this.curPage - 2; i <= this.curPage + 2; i++) {
                    // 当前页要在1-allPage之间
                    if (i > 0 && i <= this.allPage) {
                        var oLi = $('<li class="tab-number">' + i + '</li>');
                        if (i == this.curPage) {
                            oLi.addClass('cur-page')
                        }
                        $(this.wrap).append(oLi);
                    }
                }
                // 当前页数与最后一页之间搁三页及以上出现省略号
                if (this.allPage - this.curPage > 3) {
                    $(this.wrap).append($('<span>...</span>'));
                }
                // 添加最后一页
                if (this.curPage + 2 < this.allPage) {
                    $('<li class="tab-number">' + this.allPage + '</li>').appendTo($(this.wrap));
                }

                // 添加下一页按钮
                if (this.curPage < this.allPage) {
                    $(this.wrap).append($('<li class="next-page">Next</li>'));
                } else {
                    $(this.wrap).remove('.next-page');
                }


            }

            TurnPage.prototype.bindEvent = function () {
                var self = this;
                $('.prev-page', this.wrap).click(function (e) {
                    self.curPage--;
                    self.change();
                });
                $('.next-page', this.wrap).click(function () {
                    self.curPage++;
                    self.change();
                });
                $('.tab-number', this.wrap).click(function () {
                    var curPage = parseInt($(this).text());
                    self.curPage = curPage;
                    self.change();
                });
            }
            TurnPage.prototype.change = function () {
                this.fillHTML();
                this.bindEvent();
                this.changePage(this.curPage);
            }





            $.fn.extend({
                turnPage: function (options) {
                    options.wrap = this;
                    new TurnPage(options);
                    return this;
                }
            })
        }())
    </script>
    <script>
        /*
        原始数据库对照表
        list-sNo
        Name-Name
        Notes-Address
        Status-Sex
            -女-completed
            -男-waiting
        Email-Email
        Year-Age
        N/A-Mobile Number
        */
        var pageSize = 10;
        var nowPage = 1;
        var waitingTableData = [];
        var completedTableData = [];
        var searchWord = "";
        var searchStatus = -1;
        var autoUpdate = 0; //true or false, default false
        var autoUpdateClickCal = 2; //autoUpdate checkbox calculator
        var autoUpdateTimer;

        (function () {
            var birth = document.getElementById("birth");
            var birthEdit = document.getElementById("birthEdit");
            birth.setAttribute('value', new Date().getFullYear());
            birthEdit.setAttribute('value', new Date().getFullYear())
        })()

        //自动更新
        function autoUpdateHandler() {
            clearInterval(autoUpdateTimer)
            if (autoUpdateClickCal % 2 === 0) {
                autoUpdate = 1;
                // var n = 1;
                autoUpdateTimer = setInterval(() => {
                    getTableData(nowPage)
                }, 300000)
            } else {

                autoUpdate = 0;
            }

            autoUpdateClickCal++;
        }
        /**页面过滤器for waiting order
         *将所有数据获取到。然后进行分类
         *
         */
        function pageFilter(req) {
            var waitingOrders = 0; //记录waiting 人数
            var completedOrders = 0; //记录completed 人数
            var waitingCustomArr = []; //存储所有waiting order
            var completedCustomArr = []; //存储所有completed order
            for (var i = 0; i < req.length; i++) {

                if (!req[i].sex) {
                    waitingCustomArr.push(req[i])
                    waitingOrders++
                } else {
                    completedCustomArr.push(req[i])
                    completedOrders++;
                }
            }

            return {
                waitingOrders,
                waitingCustomArr,
                completedOrders,
                completedCustomArr
            }
        }
        /**模拟后端FindByPage
         * 将所有的waiting order 拿到手之后就分配页
         * data-经过pageFilter处理后的数据。
         * pageSize-用户指定的显示数量
         * curPage-当前页
         */
        function pagesHandler(data, pageSize, curPage) {
            var pageStart = 0;
            var totalPages = data.length / pageSize;
            var pageData = []; //每页的用户数据
            for (var i = 0; i < totalPages; i++) {
                pageData[i] = data.slice(pageStart, (pageStart += 15))
            }
            return {
                totalPages,
                pageData
            }
        }

        /**
         * 对订单进行排序
         */
        function sortAlg(data, method) {
            var meth = method ? method : 'default';
            if (meth === 'default') {

            }
        }

        function sNoGenerator() {
            var curDate = new Date().toLocaleDateString()
            var reg = /\//g;
            var dateList = curDate.replace(reg, '');
            var num = Math.ceil(Math.random() * 10000 + 1000)
            return num + dateList; //1000-10000
        }

        function bindEvent() {
            $('#menu').on('click', 'dd', function (e) {
                $('#menu > dd.active').removeClass('active');
                $(this).addClass('active');
                var id = $(this).attr('data-id');
                if (id == 'student-list') {
                    getTableData(nowPage);
                    $('#add-student-form')[0].reset();
                }
                if (id == 'add-student') {
                    //点击添加页面按钮时，自动生成sNo 和 email。
                    var sNum = sNoGenerator();
                    var email = sNum + '@' + 'foxmail.com'
                    $('#add-sNo').val(sNum);
                    $('#add-email').val(email)
                }
                $('.content').fadeOut();
                $('#' + id).fadeIn();
            });
            $('#edit-submit').click(function (e) {
                e.preventDefault();
                var data = $('#edit-student-form').serialize()
                transferData('/api/student/updateStudent', data, function () {
                    alert('修改成功');
                    $('#modal').slideUp();
                    $('#menu > dd[data-id=student-list]').trigger('click');
                });
            });
            $('#add-submit').click(function (e) {
                e.preventDefault();
                var data = $('#add-student-form').serialize();
                transferData('/api/student/addStudent', data, function () {
                    alert('提交成功');
                    $('#add-student-form')[0].reset();
                    $('#menu > dd[data-id=student-list]').trigger('click');
                });
            });
            // 搜索过滤功能
            $('#search-submit').click(function (e) {
                var value = $('#search-word').val();
                // 如果搜索框里面没有内容 则调用findByPage接口
                nowPage = 1;
                if (!value) {
                    getTableData(nowPage);
                    return false;
                }
                searchWord = value;
                // 有内容则 让其获取searchStudent接口数据数据
                getSearchTableData();
            });
            $('#waiting-show').click(function (e) {
                searchStatus = $('#waiting-show').val();
                getSearchTableData();
            });
            $('#completed-show').click(function (e) {
                searchStatus = $('#completed-show').val();
                getSearchTableData();
            });
            //自动更新
            // $('update-page').change(function (e) {
            //     if (this.checked) {
            //         console.log($('update-page').val())
            //         autoUpdate = $('update-page').val();
            //     }

            // })
        }


        function bindTableEvent() {
            //waiting edit 和 completed-edit 在这里完成事件绑定

            $('.waiting-edit').click(function (e) {


                var index = $(this).data('index');
                $('#modal').slideDown();
                initEditForm(waitingTableData[index]);
            });
            $('.completed-edit').click(function (e) {

                var index = $(this).data('index');
                $('#modal').slideDown();
                initEditForm(completedTableData[index]);
            });
            $('.modal-content').click(function (e) {
                e.stopPropagation();
            })
            $('#modal').click(function (e) {
                $('#modal').slideUp();
            });

            $('.waiting-del').click(function (e) {
                e.preventDefault();

                var index = $(this).data('index');
                var isDel = window.confirm('确认删除？');
                var sNo = waitingTableData[index].sNo;
                if (isDel) {
                    transferData('/api/student/delBySno', {
                        sNo: sNo
                    }, function (req) {
                        alert('删除成功');
                        $('#menu > dd[data-id=student-list]').trigger('click');
                    });
                }
            })
            $('.completed-del').click(function (e) {
                e.preventDefault();
                var index = $(this).data('index');
                var isDel = window.confirm('确认删除？');
                var sNo = completedTableData[index].sNo;
                if (isDel) {
                    transferData('/api/student/delBySno', {
                        sNo: sNo
                    }, function (req) {
                        alert('删除成功');
                        $('#menu > dd[data-id=student-list]').trigger('click');
                    });
                }
            })
        }
        // 获取表格数据
        function getTableData(page) {
            // 获取搜索前的表格数据---根据所有的数据
            transferData('/api/student/findAll', {
                page: page,
                size: pageSize
            }, function (req) {
                // 总页数
                var result = pageFilter(req.data);
                //左边栏显示统计数量
                $('#waiting-order-num-display').text(result.waitingCustomArr.length);
                $('#completed-order-num-display').text(result.completedCustomArr.length)
                var allCus = pagesHandler(result.waitingCustomArr, pageSize, page)
                // 添加翻页
                $('#turn-page').turnPage({
                    allPage: Math.ceil(allCus.totalPages),
                    curPage: page,
                    // 改变页码时触发函数 重新获取搜索后的表格数据
                    changePage: function (page) {
                        nowPage = page;
                        getTableData(page);
                    }
                });
                // 渲染数据
                var pageCustom = result.waitingCustomArr.slice(0, 15) //page1
                var pageCustom2 = result.waitingCustomArr.slice(16, 31) //16-31 page 2
                /*这里写个page函数 
                 *
                 *
                 */
                renderTable(allCus.pageData[nowPage - 1]);
                renderTable(result.completedCustomArr);
                bindTableEvent();
            });
        }
        // function getTableData(page) {
        //     // 获取搜索前的表格数据
        //     transferData('/api/student/findByPage', {
        //         page: page,
        //         size: pageSize
        //     }, function (req) {
        //         // 总页数
        //         console.log(req.data.findByPage)

        //         allPage = Math.ceil(req.data.cont / pageSize);
        //         console.log(req.data.cont)
        //         console.log(req.data)
        //         // 添加翻页
        //         $('#turn-page').turnPage({
        //             allPage: allPage,
        //             curPage: page,
        //             // 改变页码时触发函数 重新获取搜索后的表格数据
        //             changePage: function (page) {
        //                 nowPage = page;
        //                 getTableData(page);
        //             }
        //         });
        //         // 渲染数据
        //         console.log(req.data.findByPage)
        //         renderTable(req.data.findByPage);
        //         //every 10 minutes get new table
        //     });
        // }

        function getSearchTableData() {
            // 获取搜索后的表格数据
            transferData("/api/student/searchStudent", {
                sex: searchStatus,
                search: searchWord,
                page: nowPage,
                size: pageSize,
            }, function (req) {
                // 总页数
                var allPage = Math.ceil(req.data.cont / pageSize);
                // 插入翻页插件 把总页数和当前页传过去
                $('#turn-page').turnPage({
                    curPage: nowPage,
                    allPage: allPage,
                    // 切换页码时触发函数 要重新获取数据 并且当前页码保存
                    changePage: function (page) {
                        nowPage = page;
                        getSearchTableData();
                    }
                });
                // 渲染表格数据
                renderTable(req.data.searchList);
            });
        }
        // 初始化编辑的表单 （回填数据）
        function initEditForm(data) {
            // 获取到编辑的form元素
            var editForm = $('#edit-student-form')[0];
            for (var prop in data) {
                // 判断 form表单里面是否存在name=prop的input标签 若有 回填数据
                if (editForm[prop]) {
                    editForm[prop].value = data[prop];
                }
            }
        }

        function init() {
            bindEvent();
            $('#menu > dd').eq(0).trigger('click');
        }
        init();

        function renderTable(data) {
            var strWaiting = '';
            var strCompleted = '';
            data.forEach(function (item, index) {

                if (!item.sex) {
                    waitingTableData = data;
                    strWaiting += '<tr>\
        <td>' + item.sNo + '</td>\
        <td> ' + item.name + ' </td>\
        <td> ' + item.address + '</td>\
        <td class="table-danger">' + (item.sex ? 'Completed' : 'Waiting') + '</td>\
        <td>\
            <button class="btn waiting-edit" data-index=' + index + '><i class="far fa-edit"></i></button>\
            <button class="btn waiting-del" data-index=' + index + '><i class="far fa-trash-alt"></i></button>\
        </td>\
        </tr>'
                    $('#student-body-waiting').html(strWaiting);


                } else {
                    completedTableData = data;
                    strCompleted += '<tr>\
                      <td>' + item.sNo + '</td>\
                      <td> ' + item.name + ' </td>\
                      <td> ' + item.address + '</td>\
                      <td class="table-success">' + (item.sex ? 'Completed' : 'Waiting') + '</td>\
                      <td>\
                          <button class="btn completed-edit" data-index=' + index + '><i class="far fa-edit"></i></button>\
                          <button class="btn completed-del" data-index=' + index + '><i class="far fa-trash-alt"></i></button>\
                      </td>\
                  </tr>'
                    $('#student-body-completed').html(strCompleted);

                }

            });

        }
        // var n = 1;
        // 不一样的作为参数传递 相同的代码封装到函数里面
        function transferData(api, data, callback) {

            if ($.type(data) == 'string') {
                data += "&appkey=Allied01_1626182895004";
            } else {
                data = $.extend(data, {
                    appkey: 'Allied01_1626182895004'
                });
            }
            $.ajax({
                type: 'get',
                url: 'https://open.duyiedu.com' + api,
                data: data,
                dataType: 'json',
                success: function (req) {
                    // console.log(this.url)
                    if (req.status == 'success') {
                        callback(req);
                        // n++
                        // console.log('ajax request times:' + n)
                    } else {
                        alert(req.msg);
                    }
                }
            });
        }
    </script>
</body>

</html>
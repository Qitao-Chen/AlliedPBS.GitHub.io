<!DOCTYPE html>
<html lang="en">

<head>
    <!-- <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"> -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="./index.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
</head>
<script src="https://kit.fontawesome.com/faca7d3472.js" crossorigin="anonymous"></script>

<body>
    <div class="wrapper">
        <div class="header">
            <div class="logo">
                <img src="https://alliedgamingpc.com.au//wp-content/uploads/2019/11/allied-logo-inverse.png" alt="">
                <!-- <span>Allied Gaming</span> -->
            </div>
        </div>
        <div class="left-menu">
            <dl id="menu">
                <dt>Priority Build</dt>
                <dd class="active" data-id="student-list">Order List</dd>
                <dd data-id="add-student">Add Order</dd>
            </dl>
        </div>
        <div class="right-content">
            <!-- 学生列表 -->
            <div class="student-list content" id="student-list">
                <div class="search">
                    <label for="search-word">KeyWords Search:</label>
                    <input type="text" id="search-word">
                    <button id="search-submit">search</button>
                    <!-- 新增功能 -->
                    <input style="margin-left: 5px;" id="waiting-show" type="radio" name="sex" value="0">
                    <label for="waiting-show">Waiting</label>
                    <input style="margin-left: 5px;" id="completed-show" type="radio" name="sex" value="1">
                    <label for="completed-show">Completed</label>
                    <input style="margin-left: 5px;" type="checkbox" id="update-page" name="autoUpdate"
                        onclick="autoUpdateHandler()">
                    <label for="update-page">Auto Update</label>
                </div>
                <table border="0" class="table table-hover table-light">
                    <!-- 表头区域 -->
                    <thead>
                        <tr>
                            <th scope="col">List</th>
                            <th scope="col">Name</th>
                            <th scope="col">Order Number</th>
                            <th scope="col">Status</th>
                            <th scope="col">Email</th>
                            <th scope="col">Year</th>
                            <th scope="col">N/A</th>
                            <th scope="col">Operation</th>
                        </tr>
                    </thead>
                    <!-- 表格内容 -->
                    <tbody id="student-body">
                    </tbody>
                </table>
                <ul id="turn-page">
                </ul>
                <div class="modal" id="modal">
                    <div class="mask"></div>
                    <div class="modal-content">
                        <h2>Edit Order</h2>
                        <form action="#" id="edit-student-form" class="add-student-form">
                            <div class="row-mb-3">
                                <label for="name" class="col-sm-2 col-form-label col-form-label-sm">Name</label>
                                <div class="short-input col-md-8">
                                    <input type="text" name="name" autocomplete="off"
                                        class="form-control form-control-sm">
                                </div>
                            </div>
                            <div class="sex">
                                <label for="sex">Status</label>
                                <input type="radio" name="sex" checked value="0">
                                <span>waiting</span>
                                <input type="radio" name="sex" value="1"><span>completed</span>
                            </div>

                            <div class="row-mb-3">
                                <label for="sNo" class="col-sm-2 col-form-label">List</label>
                                <div class="short-input col-md-8">
                                    <input type="text" name="sNo" class="form-control">
                                </div>
                            </div>
                            <div class="row-mb-3">
                                <label for="email" class="col-sm-2 col-form-label">Email</label>
                                <div class="short-input col-md-8">
                                    <input type="text" name="email" class="form-control">
                                </div>
                            </div>
                            <div class="row-mb-3">
                                <label for="birth" class="col-sm-2 col-form-label">Year</label>
                                <div class="short-input col-md-8">
                                    <input type="text" name="birth" class="form-control" id="birthEdit"
                                        disabled="disabled">
                                </div>
                            </div>
                            <div class="row-mb-3">
                                <label for="phone" class="col-sm-2 col-form-label">N/A</label>
                                <div class="short-input col-md-8">
                                    <input type="text" name="phone" class="form-control" disabled="disabled"
                                        value="13000000000">
                                </div>
                            </div>
                            <div class="row-mb-3">
                                <label for="address" class="col-sm-2 col-form-label">Order No.</label>
                                <div class="short-input col-md-8">
                                    <input type="text" name="address" class="form-control">
                                </div>
                            </div>
                            <div>
                                <label for=""></label>
                                <input type="submit" value="Submit" class="btn btn-primary" id="edit-submit">
                                <input type="reset" value="Reset" class="btn btn-danger">
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <!-- 新增学生表单 -->
            <div class="add-student content" id="add-student">
                <form action="#" id="add-student-form" class="add-student-form">
                    <div class="row-mb-3">
                        <label for="name" class="col-sm-2 col-form-label col-form-label-sm">Name</label>
                        <div class="short-input col-md-8">
                            <input type="text" name="name" autocomplete="off" class="form-control form-control-sm">
                        </div>
                    </div>
                    <div class="sex">
                        <label for="sex">Status</label>
                        <input type="radio" name="sex" checked value="0">
                        <span>waiting</span>
                        <input type="radio" name="sex" value="1"><span>completed</span>
                    </div>

                    <div class="row-mb-3">
                        <label for="sNo" class="col-sm-2 col-form-label">List</label>
                        <div class="short-input col-md-8">
                            <input type="text" name="sNo" class="form-control">
                        </div>
                    </div>
                    <div class="row-mb-3">
                        <label for="email" class="col-sm-2 col-form-label">Email</label>
                        <div class="short-input col-md-8">
                            <input type="text" name="email" class="form-control">
                        </div>
                    </div>
                    <div class="row-mb-3">
                        <label for="birth" class="col-sm-2 col-form-label">Year</label>
                        <div class="short-input col-md-8">
                            <input type="text" name="birth" class="form-control" id="birth">
                        </div>
                    </div>
                    <div class="row-mb-3">
                        <label for="phone" class="col-sm-2 col-form-label">N/A</label>
                        <div class="short-input col-md-8">
                            <input type="text" name="phone" class="form-control" value="13000000000">
                        </div>
                    </div>
                    <div class="row-mb-3">
                        <label for="address" class="col-sm-2 col-form-label">Order No.</label>
                        <div class="short-input col-md-8">
                            <input type="text" name="address" class="form-control">
                        </div>
                    </div>
                    <div>
                        <label for=""></label>
                        <input type="submit" value="Submit" class="btn btn-primary" id="add-submit">
                        <input type="reset" value="Reset" class="btn btn-danger">
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.js"
        integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous">
    </script>
    <script>
        (function () {

            function TurnPage(options) {
                this.wrap = options.wrap;
                this.curPage = options.curPage || 1;
                this.allPage = options.allPage || 1;
                this.changePage = options.changePage || function () {};

                if (this.curPage > this.allPage) {
                    alert('请输入正确页码');
                    return false;
                }
                this.fillHTML();
                this.bindEvent();
            }
            TurnPage.prototype.fillHTML = function () {
                $(this.wrap).empty();
                // 添加上一页按钮
                if (this.curPage > 1) {
                    $(this.wrap).append($('<li class="prev-page">上一页</li>'));
                } else {
                    $(this.wrap).remove('.prev-page');
                }

                // 填充中间页 
                // 如果当前页不是第一页  并且当前页与第一页之间差2页以及两页以上  添加第一页
                if (this.curPage != 1 && this.curPage - 2 > 1) {
                    $(this.wrap).append($('<li class="tab-number">1</li>'));
                }

                // 如果当前页的前两页 大于第二页 则出现省略号
                if (this.curPage - 2 > 2) {
                    $(this.wrap).append($('<span>...</span>'));
                }

                // 渲染当前页数左右两页
                for (var i = this.curPage - 2; i <= this.curPage + 2; i++) {
                    // 当前页要在1-allPage之间
                    if (i > 0 && i <= this.allPage) {
                        var oLi = $('<li class="tab-number">' + i + '</li>');
                        if (i == this.curPage) {
                            oLi.addClass('cur-page')
                        }
                        $(this.wrap).append(oLi);
                    }
                }
                // 当前页数与最后一页之间搁三页及以上出现省略号
                if (this.allPage - this.curPage > 3) {
                    $(this.wrap).append($('<span>...</span>'));
                }
                // 添加最后一页
                if (this.curPage + 2 < this.allPage) {
                    $('<li class="tab-number">' + this.allPage + '</li>').appendTo($(this.wrap));
                }

                // 添加下一页按钮
                if (this.curPage < this.allPage) {
                    $(this.wrap).append($('<li class="next-page">下一页</li>'));
                } else {
                    $(this.wrap).remove('.next-page');
                }


            }

            TurnPage.prototype.bindEvent = function () {
                var self = this;
                $('.prev-page', this.wrap).click(function (e) {
                    self.curPage--;
                    self.change();
                });
                $('.next-page', this.wrap).click(function () {
                    self.curPage++;
                    self.change();
                });
                $('.tab-number', this.wrap).click(function () {
                    var curPage = parseInt($(this).text());
                    self.curPage = curPage;
                    self.change();
                });
            }
            TurnPage.prototype.change = function () {
                this.fillHTML();
                this.bindEvent();
                this.changePage(this.curPage);
            }





            $.fn.extend({
                turnPage: function (options) {
                    options.wrap = this;
                    new TurnPage(options);
                    return this;
                }
            })
        }())
    </script>
    <script>
        /*
        原始数据库对照表
        list-sNo
        Name-Name
        OrderNumber-Address
        Status-Sex
            -女-completed
            -男-waiting
        Email-Email
        Year-Age
        N/A-Mobile Number
        */
        var pageSize = 10;
        var nowPage = 1;
        var tableData = [];
        var searchWord = "";
        var searchStatus = -1;
        var autoUpdate = 0; //true or false, default false
        var autoUpdateClickCal = 2; //autoUpdate checkbox calculator
        var autoUpdateTimer;

        (function () {
            var birth = document.getElementById("birth");
            var birthEdit = document.getElementById("birthEdit");
            console.log(birthEdit)
            birth.setAttribute('value', new Date().getFullYear() - 1);
            birthEdit.setAttribute('value', new Date().getFullYear() - 1)
        })()

        function bindEvent() {
            $('#menu').on('click', 'dd', function (e) {
                $('#menu > dd.active').removeClass('active');
                $(this).addClass('active');
                var id = $(this).attr('data-id');
                // console.log($(this).data('id'))
                if (id == 'student-list') {
                    getTableData(nowPage);
                    $('#add-student-form')[0].reset();
                }
                $('.content').fadeOut();
                $('#' + id).fadeIn();
            });
            $('#edit-submit').click(function (e) {
                e.preventDefault();
                var data = $('#edit-student-form').serialize()
                console.log(data)
                transferData('/api/student/updateStudent', data, function () {
                    alert('修改成功');
                    $('#modal').slideUp();
                    $('#menu > dd[data-id=student-list]').trigger('click');
                });
            });
            $('#add-submit').click(function (e) {
                e.preventDefault();
                var data = $('#add-student-form').serialize();
                transferData('/api/student/addStudent', data, function () {
                    alert('提交成功');
                    $('#add-student-form')[0].reset();
                    $('#menu > dd[data-id=student-list]').trigger('click');
                });
            });
            // 搜索过滤功能
            $('#search-submit').click(function (e) {
                var value = $('#search-word').val();
                // 如果搜索框里面没有内容 则调用findByPage接口
                nowPage = 1;
                if (!value) {
                    getTableData(nowPage);
                    return false;
                }
                searchWord = value;
                // 有内容则 让其获取searchStudent接口数据数据
                getSearchTableData();
            });
            $('#waiting-show').click(function (e) {
                searchStatus = $('#waiting-show').val();
                getSearchTableData();
            });
            $('#completed-show').click(function (e) {
                searchStatus = $('#completed-show').val();
                getSearchTableData();
            });
            //自动更新
            // $('update-page').change(function (e) {
            //     if (this.checked) {
            //         console.log($('update-page').val())
            //         autoUpdate = $('update-page').val();
            //     }

            // })
        }
        //自动更新
        function autoUpdateHandler() {
            clearInterval(autoUpdateTimer)
            if (autoUpdateClickCal % 2 === 0) {
                autoUpdate = 1;
                // var n = 1;
                autoUpdateTimer = setInterval(() => {

                    getTableData(nowPage)
                    // console.log(n++)
                }, 300000)

            } else {

                autoUpdate = 0;
            }

            autoUpdateClickCal++;
        }

        function bindTableEvent() {
            $('.edit').click(function (e) {
                var index = $(this).data('index');
                $('#modal').slideDown();
                initEditForm(tableData[index]);
            });
            $('.modal-content').click(function (e) {
                e.stopPropagation();
            })
            $('#modal').click(function (e) {
                $('#modal').slideUp();
            });

            $('.del').click(function (e) {
                var index = $(this).data('index');
                var isDel = window.confirm('确认删除？');
                var sNo = tableData[index].sNo;
                if (isDel) {
                    transferData('/api/student/delBySno', {
                        sNo: sNo
                    }, function (req) {
                        alert('删除成功');
                        $('#menu > dd[data-id=student-list]').trigger('click');
                    });
                }
            })
        }
        // 获取表格数据
        function getTableData(page) {
            // 获取搜索前的表格数据
            transferData('/api/student/findByPage', {
                page: page,
                size: pageSize
            }, function (req) {
                // 总页数
                allPage = Math.ceil(req.data.cont / pageSize);
                // 添加翻页
                $('#turn-page').turnPage({
                    allPage: allPage,
                    curPage: page,
                    // 改变页码时触发函数 重新获取搜索后的表格数据
                    changePage: function (page) {
                        nowPage = page;
                        getTableData(page);
                    }
                });
                // 渲染数据
                renderTable(req.data.findByPage);
                //every 10 minutes get new table
                // if (autoUpdate) {
                //     autoUpdateTimer = setInterval(() => {
                //         renderTable(req.data.findByPage);
                //         console.log('n')
                //     }, 6000)
                // }

            });
        }

        function getSearchTableData() {
            // 获取搜索后的表格数据
            transferData("/api/student/searchStudent", {
                sex: searchStatus,
                search: searchWord,
                page: nowPage,
                size: pageSize,
            }, function (req) {
                // 总页数
                var allPage = Math.ceil(req.data.cont / pageSize);
                // 插入翻页插件 把总页数和当前页传过去
                $('#turn-page').turnPage({
                    curPage: nowPage,
                    allPage: allPage,
                    // 切换页码时触发函数 要重新获取数据 并且当前页码保存
                    changePage: function (page) {
                        nowPage = page;
                        getSearchTableData();
                    }
                });
                // 渲染表格数据
                renderTable(req.data.searchList);
            });
        }
        // 初始化编辑的表单 （回填数据）
        function initEditForm(data) {
            // 获取到编辑的form元素
            var editForm = $('#edit-student-form')[0];
            for (var prop in data) {
                // 判断 form表单里面是否存在name=prop的input标签 若有 回填数据
                if (editForm[prop]) {
                    editForm[prop].value = data[prop];
                }
            }
        }

        function init() {
            bindEvent();
            $('#menu > dd').eq(0).trigger('click');
        }
        init();

        function renderTable(data) {
            tableData = data;
            var str = '';
            data.forEach(function (item, index) {
                str += '<tr>\
        <td>' + item.sNo + '</td>\
        <td> ' + item.name + ' </td>\
        <td> ' + item.address + '</td>\
        <td>' + (item.sex ? 'Completed' : 'Waiting') + '</td>\
        <td> ' + item.email + '</td>\
        <td>' + (item.birth) + '</td>\
        <td> ' + item.phone + '</td>\
        <td>\
            <button class="btn edit" data-index=' + index + '><i class="far fa-edit"></i></button>\
            <button class="btn del" data-index=' + index + '><i class="far fa-trash-alt"></i></button>\
        </td>\
    </tr>';

            });
            $('#student-body').html(str);
            bindTableEvent();
        }
        // var n = 1;
        // 不一样的作为参数传递 相同的代码封装到函数里面
        function transferData(api, data, callback) {

            if ($.type(data) == 'string') {
                data += "&appkey=Allied01_1626182895004";
            } else {
                data = $.extend(data, {
                    appkey: 'Allied01_1626182895004'
                });
            }
            $.ajax({
                type: 'get',
                url: 'https://open.duyiedu.com' + api,
                data: data,
                dataType: 'json',
                success: function (req) {
                    // console.log(this.url)
                    if (req.status == 'success') {
                        callback(req);
                        // n++
                        // console.log('ajax request times:' + n)
                    } else {
                        alert(req.msg);
                    }
                }
            });
        }
    </script>
</body>

</html>
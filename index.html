<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="./index.css">
</head>

<body>
    <div class="wrapper">
        <div class="header">
            <div class="logo">
                <img src="./images/logo.png" alt="">
                <span>渡一教育</span>
            </div>
        </div>
        <div class="left-menu">
            <dl id="menu">
                <dt>学生管理</dt>
                <dd class="active" data-id="student-list">学生列表</dd>
                <dd data-id="add-student">新增学生</dd>
            </dl>
        </div>
        <div class="right-content">
            <!-- 学生列表 -->
            <div class="student-list content" id="student-list">
                <div class="search">
                    <label for="search-word">关键字搜索:</label>
                    <input type="text" id="search-word">
                    <button id="search-submit">搜索</button>
                </div>
                <table border="0">
                    <!-- 表头区域 -->
                    <thead>
                        <tr>
                            <th>学号</th>
                            <th>姓名</th>
                            <th>性别</th>
                            <th>邮箱</th>
                            <th>年龄</th>
                            <th>手机号</th>
                            <th>住址</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <!-- 表格内容 -->
                    <tbody id="student-body">
                        <!-- <tr>
                            <td>1222</td>
                            <td> dmq </td>
                            <td>男</td>
                            <td> 123123@qq.com</td>
                            <td>
                                18
                            </td>
                            <td> 12312312312</td>
                            <td> 北京</td>
                            <td>
                                <button class="btn edit">编辑</button>
                                <button class="btn del">删除</button>
                            </td>
                        </tr> -->
                    </tbody>
                </table>
                <ul id="turn-page">
                    <!-- <li class="prev-page">上一页</li>
                   <li class="active tcdNumber">1</li>
                   <li class="tcdNumber">2</li>
                   <li class="tcdNumber">3</li>
                   <span>...</span>
                   <li class="tcdNumber">8</li>
                   <li class="tcdNumber">9</li>
                   <li class="tcdNumber">10</li>
                   <li class="next-page">下一页</li> -->
                </ul>
                <div class="modal" id="modal">
                    <div class="mask"></div>
                    <div class="modal-content">
                        <h2>编辑信息</h2>
                        <form action="#" id="edit-student-form" class="add-student-form">
                            <div>
                                <label for="name">姓名</label>
                                <input type="text" name="name" autocomplete="off">
                            </div>
                            <div class="sex">
                                <label for="sex">性别</label>
                                <input type="radio" name="sex" checked value="0">
                                <span>男</span>
                                <input type="radio" name="sex" value="1"><span>女</span>
                            </div>
                            <div>
                                <label for="sNo">学号</label>
                                <input type="text" name="sNo">
                            </div>
                            <div>
                                <label for="email">邮箱</label>
                                <input type="text" name="email">
                            </div>
                            <div>
                                <label for="birth">出生年</label>
                                <input type="text" name="birth">
                            </div>
                            <div>
                                <label for="phone">手机号</label>
                                <input type="text" name="phone">
                            </div>
                            <div>
                                <label for="address">住址</label>
                                <input type="text" name="address">
                            </div>
                            <div>
                                <label for=""></label>
                                <input type="submit" value="提交" class="btn" id="edit-submit">
                                <input type="reset" value="重置" class="btn">
                            </div>
                        </form>
                    </div>
                </div>




            </div>
            <!-- 新增学生表单 -->
            <div class="add-student content" id="add-student">
                <form action="#" id="add-student-form" class="add-student-form">
                    <div>
                        <label for="name">姓名</label>
                        <input type="text" name="name" autocomplete="off">
                    </div>
                    <div class="sex">
                        <label for="sex">性别</label>
                        <input type="radio" name="sex" checked value="0">
                        <span>男</span>
                        <input type="radio" name="sex" value="1"><span>女</span>
                    </div>
                    <div>
                        <label for="sNo">学号</label>
                        <input type="text" id="sNo" name="sNo">
                    </div>
                    <div>
                        <label for="email">邮箱</label>
                        <input type="text" id="email" name="email">
                    </div>
                    <div>
                        <label for="birth">出生年</label>
                        <input type="text" id="birth" name="birth">
                    </div>
                    <div>
                        <label for="phone">手机号</label>
                        <input type="text" id="phone" name="phone">
                    </div>
                    <div>
                        <label for="address">住址</label>
                        <input type="text" id="address" name="address">
                    </div>
                    <div>
                        <label for=""></label>
                        <input type="submit" value="提交" class="btn" id="add-submit">
                        <input type="reset" value="重置" class="btn">
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.js"
        integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous">



    </script>
    <script>
        (function () {

            function TurnPage(options) {
                this.wrap = options.wrap;
                this.curPage = options.curPage || 1;
                this.allPage = options.allPage || 1;
                this.changePage = options.changePage || function () {};

                if (this.curPage > this.allPage) {
                    alert('请输入正确页码');
                    return false;
                }
                this.fillHTML();
                this.bindEvent();
            }
            TurnPage.prototype.fillHTML = function () {
                $(this.wrap).empty();
                // 添加上一页按钮
                if (this.curPage > 1) {
                    $(this.wrap).append($('<li class="prev-page">上一页</li>'));
                } else {
                    $(this.wrap).remove('.prev-page');
                }

                // 填充中间页 
                // 如果当前页不是第一页  并且当前页与第一页之间差2页以及两页以上  添加第一页
                if (this.curPage != 1 && this.curPage - 2 > 1) {
                    $(this.wrap).append($('<li class="tab-number">1</li>'));
                }

                // 如果当前页的前两页 大于第二页 则出现省略号
                if (this.curPage - 2 > 2) {
                    $(this.wrap).append($('<span>...</span>'));
                }

                // 渲染当前页数左右两页
                for (var i = this.curPage - 2; i <= this.curPage + 2; i++) {
                    // 当前页要在1-allPage之间
                    if (i > 0 && i <= this.allPage) {
                        var oLi = $('<li class="tab-number">' + i + '</li>');
                        if (i == this.curPage) {
                            oLi.addClass('cur-page')
                        }
                        $(this.wrap).append(oLi);
                    }
                }
                // 当前页数与最后一页之间搁三页及以上出现省略号
                if (this.allPage - this.curPage > 3) {
                    $(this.wrap).append($('<span>...</span>'));
                }
                // 添加最后一页
                if (this.curPage + 2 < this.allPage) {
                    $('<li class="tab-number">' + this.allPage + '</li>').appendTo($(this.wrap));
                }

                // 添加下一页按钮
                if (this.curPage < this.allPage) {
                    $(this.wrap).append($('<li class="next-page">下一页</li>'));
                } else {
                    $(this.wrap).remove('.next-page');
                }


            }

            TurnPage.prototype.bindEvent = function () {
                var self = this;
                $('.prev-page', this.wrap).click(function (e) {
                    self.curPage--;
                    self.change();
                });
                $('.next-page', this.wrap).click(function () {
                    self.curPage++;
                    self.change();
                });
                $('.tab-number', this.wrap).click(function () {
                    var curPage = parseInt($(this).text());
                    self.curPage = curPage;
                    self.change();
                });
            }
            TurnPage.prototype.change = function () {
                this.fillHTML();
                this.bindEvent();
                this.changePage(this.curPage);
            }





            $.fn.extend({
                turnPage: function (options) {
                    options.wrap = this;
                    new TurnPage(options);
                    return this;
                }
            })
        }())
    </script>
    <script>
        var pageSize = 10;
        var nowPage = 1;
        var tableData = [];
        var searchWord = "";

        function bindEvent() {
            $('#menu').on('click', 'dd', function (e) {
                $('#menu > dd.active').removeClass('active');
                $(this).addClass('active');
                var id = $(this).attr('data-id');
                // console.log($(this).data('id'))
                if (id == 'student-list') {
                    getTableData(nowPage);
                    $('#add-student-form')[0].reset();
                }
                $('.content').fadeOut();
                $('#' + id).fadeIn();
            });
            $('#edit-submit').click(function (e) {
                e.preventDefault();
                var data = $('#edit-student-form').serialize()
                transferData('/api/student/updateStudent', data, function () {
                    alert('修改成功');
                    $('#modal').slideUp();
                    $('#menu > dd[data-id=student-list]').trigger('click');
                });
            });
            $('#add-submit').click(function (e) {
                e.preventDefault();
                var data = $('#add-student-form').serialize();
                transferData('/api/student/addStudent', data, function () {
                    alert('提交成功');
                    $('#add-student-form')[0].reset();
                    $('#menu > dd[data-id=student-list]').trigger('click');
                });
            });
            // 搜索过滤功能
            $('#search-submit').click(function (e) {
                var value = $('#search-word').val();
                // 如果搜索框里面没有内容 则调用findByPage接口
                nowPage = 1;
                if (!value) {
                    getTableData(nowPage);
                    return false;
                }
                searchWord = value;
                // 有内容则 让其获取searchStudent接口数据数据
                getSearchTableData();
            })

        }

        function bindTableEvent() {
            $('.edit').click(function (e) {
                var index = $(this).data('index');
                $('#modal').slideDown();
                initEditForm(tableData[index]);
            });
            $('.modal-content').click(function (e) {
                e.stopPropagation();
            })
            $('#modal').click(function (e) {
                $('#modal').slideUp();
            });

            $('.del').click(function (e) {
                var index = $(this).data('index');
                var isDel = window.confirm('确认删除？');
                var sNo = tableData[index].sNo;
                if (isDel) {
                    transferData('/api/student/delBySno', {
                        sNo: sNo
                    }, function (req) {
                        alert('删除成功');
                        $('#menu > dd[data-id=student-list]').trigger('click');
                    });
                }
            })
        }
        // 获取表格数据
        function getTableData(page) {
            // 获取搜索前的表格数据
            transferData('/api/student/findByPage', {
                page: page,
                size: pageSize
            }, function (req) {
                // 总页数
                allPage = Math.ceil(req.data.cont / pageSize);
                // 添加翻页
                $('#turn-page').turnPage({
                    allPage: allPage,
                    curPage: page,
                    // 改变页码时触发函数 重新获取搜索后的表格数据
                    changePage: function (page) {
                        nowPage = page;
                        getTableData(page);
                    }
                });
                // 渲染数据
                renderTable(req.data.findByPage);
            });
        }

        function getSearchTableData() {
            // 获取搜索后的表格数据
            transferData("/api/student/searchStudent", {
                sex: -1,
                search: searchWord,
                page: nowPage,
                size: pageSize,
            }, function (req) {
                // 总页数
                var allPage = Math.ceil(req.data.cont / pageSize);
                // 插入翻页插件 把总页数和当前页传过去
                $('#turn-page').turnPage({
                    curPage: nowPage,
                    allPage: allPage,
                    // 切换页码时触发函数 要重新获取数据 并且当前页码保存
                    changePage: function (page) {
                        nowPage = page;
                        getSearchTableData();
                    }
                });
                // 渲染表格数据
                renderTable(req.data.searchList);
            });
        }
        // 初始化编辑的表单 （回填数据）
        function initEditForm(data) {
            // 获取到编辑的form元素
            var editForm = $('#edit-student-form')[0];
            for (var prop in data) {
                // 判断 form表单里面是否存在name=prop的input标签 若有 回填数据
                if (editForm[prop]) {
                    editForm[prop].value = data[prop];
                }
            }
        }

        function init() {
            bindEvent();
            $('#menu > dd').eq(0).trigger('click');
        }
        init();

        function renderTable(data) {
            tableData = data;
            var str = '';
            data.forEach(function (item, index) {
                str += '<tr>\
        <td>' + item.sNo + '</td>\
        <td> ' + item.name + ' </td>\
        <td>' + (item.sex ? '女' : '男') + '</td>\
        <td> ' + item.email + '</td>\
        <td>' + (new Date().getFullYear() - item.birth) + '</td>\
        <td> ' + item.phone + '</td>\
        <td> ' + item.address + '</td>\
        <td>\
            <button class="btn edit" data-index=' + index + '>编辑</button>\
            <button class="btn del" data-index=' + index + '>删除</button>\
        </td>\
    </tr>';
            });
            $('#student-body').html(str);
            bindTableEvent();
        }
        // 不一样的作为参数传递 相同的代码封装到函数里面
        function transferData(api, data, callback) {
            if ($.type(data) == 'string') {
                data += "&appkey=qitao_1625724881815";
            } else {
                data = $.extend(data, {
                    appkey: 'qitao_1625724881815'
                });
            }
            $.ajax({
                type: 'get',
                url: 'https://open.duyiedu.com' + api,
                data: data,
                dataType: 'json',
                success: function (req) {
                    console.log(this.url)
                    if (req.status == 'success') {
                        callback(req);

                    } else {
                        alert(req.msg);
                    }
                }
            });
        }
    </script>
</body>

</html>